<style>
    /* ... CSS เดิม ... */
    
    /* --- CSS ใหม่สำหรับ IMC Filter --- */
    .imc-filter-box { background: white; padding: 15px; border-radius: 16px; margin-bottom: 20px; box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0; }
    .filter-group { margin-bottom: 12px; }
    .filter-title { font-size: 0.9rem; font-weight: 700; color: #334155; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
    
    .radio-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .radio-pill { cursor: pointer; position: relative; }
    .radio-pill input { position: absolute; opacity: 0; }
    .radio-pill span { display: block; padding: 6px 14px; background: #f1f5f9; border-radius: 20px; font-size: 0.85rem; color: #64748b; border: 1px solid transparent; transition: all 0.2s; }
    .radio-pill input:checked + span { background: #9333ea; color: white; box-shadow: 0 4px 10px rgba(147, 51, 234, 0.3); font-weight: 600; }

    .chk-group { display: flex; gap: 10px; }
    .chk-pill { cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #fff; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 0.9rem; color: #475569; transition: all 0.2s; }
    .chk-pill:hover { border-color: #9333ea; }
    .chk-pill input:checked + span { color: #9333ea; font-weight: 700; }
    .chk-pill.active { border-color: #9333ea; background: #faf5ff; }

    .imc-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid #f1f5f9; box-shadow: var(--shadow-sm); animation: slideUp 0.3s; position: relative; overflow: hidden; }
    .imc-card::before { content: ''; position: absolute; top: 0; bottom: 0; left: 0; width: 6px; background: #9333ea; }
    .imc-time { font-weight: 700; color: #9333ea; font-size: 1.1rem; margin-bottom: 6px; }
    .imc-detail { font-size: 0.9rem; color: #334155; line-height: 1.5; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px dashed #cbd5e1; }
    .imc-tags { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
    .imc-tag { font-size: 0.75rem; padding: 3px 8px; border-radius: 6px; font-weight: 600; }
    .tag-pt { background: #e0f2fe; color: #0369a1; }
    .tag-ttm { background: #dcfce7; color: #15803d; }
    .tag-tcm { background: #fee2e2; color: #b91c1c; }

</style>

<script>
    // ... (ส่วน Config อื่นๆ เหมือนเดิม) ...

    // ** ตัวแปรสำหรับ Filter IMC **
    let imcFilter = {
        pt: 'all', // all, none, 60, 90
        ttm: false,
        tcm: false
    };

    // แก้ไขฟังก์ชัน toggleLanguage และ renderApp เล็กน้อย
    // ...

    function renderIMCTable(dayIndex) {
       // ใช้ Data จาก Global ที่โหลดมาแล้ว
       let dayData = globalData[dayIndex];
       let container = document.getElementById('contentArea');
       let dayColor = DAY_COLORS[dayData.dayOfWeek];
       
       let headerHtml = `<div class="selected-date-header"><span class="header-bar" style="background-color: ${dayColor}"></span>${dayData.fullLabel || dayData.displayDate}</div>`;

       // --- 1. ส่วนตัวกรอง (Filter UI) ---
       let filterHtml = `
       <div class="imc-filter-box">
           <div class="filter-group">
               <div class="filter-title"><i class="fas fa-wheelchair"></i> กายภาพบำบัด</div>
               <div class="radio-group">
                   <label class="radio-pill"><input type="radio" name="pt_dur" value="all" onchange="updateIMCFilter('pt', 'all')" checked><span>ทั้งหมด</span></label>
                   <label class="radio-pill"><input type="radio" name="pt_dur" value="none" onchange="updateIMCFilter('pt', 'none')"><span>ไม่ทำกายภาพ</span></label>
                   <label class="radio-pill"><input type="radio" name="pt_dur" value="60" onchange="updateIMCFilter('pt', '60')"><span>1 ชม.</span></label>
                   <label class="radio-pill"><input type="radio" name="pt_dur" value="90" onchange="updateIMCFilter('pt', '90')"><span>1.5 ชม.</span></label>
               </div>
           </div>
           <div class="filter-group">
               <div class="filter-title"><i class="fas fa-plus-circle"></i> บริการร่วม</div>
               <div class="chk-group">
                   <label class="chk-pill" id="lbl-ttm">
                       <input type="checkbox" onchange="updateIMCFilter('ttm', this.checked)">
                       <i class="fas fa-hands"></i> <span>นวดไทย</span>
                   </label>
                   <label class="chk-pill" id="lbl-tcm">
                       <input type="checkbox" onchange="updateIMCFilter('tcm', this.checked)">
                       <i class="fas fa-syringe"></i> <span>ฝังเข็ม</span>
                   </label>
               </div>
           </div>
       </div>
       <div id="imc-slots-area"></div>
       `;
       
       container.innerHTML = headerHtml + filterHtml;
       
       // เรียกฟังก์ชันแสดงรายการ Slots ตาม Filter ปัจจุบัน
       renderIMCSlots(dayData);
    }

    function updateIMCFilter(key, val) {
        imcFilter[key] = val;
        // Update UI styles (Optional)
        if(key === 'ttm') document.getElementById('lbl-ttm').classList.toggle('active', val);
        if(key === 'tcm') document.getElementById('lbl-tcm').classList.toggle('active', val);

        // Re-render only slot area
        let dayData = globalData[selectedIndex];
        renderIMCSlots(dayData);
    }

    function renderIMCSlots(dayData) {
        let area = document.getElementById('imc-slots-area');
        
        if (!dayData || !dayData.slots || dayData.slots.length === 0) {
            area.innerHTML = `<div style="text-align:center;padding:30px;color:#999">${t('no_slot')}</div>`;
            return;
        }

        let html = "";
        let foundCount = 0;

        // วนลูปแต่ละช่วงเวลา
        dayData.slots.forEach(slot => {
            if(!slot.imcData) return;

            // วนลูปแต่ละ Package ในช่วงเวลานั้น
            slot.imcData.forEach(pkg => {
                // --- LOGIC การกรอง (FILTER) ---
                let h = pkg.category; // ชื่อ Header
                
                // 1. กรองกายภาพ
                let isPT60 = h.includes("กายภาพ 1 ชม.") && !h.includes("30 นาที");
                let isPT90 = h.includes("กายภาพ 1 ชม. 30 นาที");
                let hasPT = h.includes("กายภาพ");

                if (imcFilter.pt === 'none' && hasPT) return;
                if (imcFilter.pt === '60' && !isPT60) return;
                if (imcFilter.pt === '90' && !isPT90) return;

                // 2. กรองนวด
                let hasMassage = h.includes("นวด");
                if (imcFilter.ttm && !hasMassage) return;

                // 3. กรองฝังเข็ม
                let hasAcu = h.includes("ฝังเข็ม");
                if (imcFilter.tcm && !hasAcu) return;

                // --- ผ่านการกรองแล้ว แสดงผล ---
                foundCount++;
                
                // สร้าง Tags
                let tags = "";
                if(hasPT) tags += `<span class="imc-tag tag-pt">${isPT90 ? 'กายภาพ 1.5h' : 'กายภาพ 1h'}</span>`;
                if(hasMassage) tags += `<span class="imc-tag tag-ttm">นวดไทย</span>`;
                if(hasAcu) tags += `<span class="imc-tag tag-tcm">ฝังเข็ม</span>`;

                // ปุ่มจอง ส่งข้อความยาวๆ ไปด้วย
                html += `
                <div class="imc-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div class="imc-time">${slot.time} น.</div>
                            <div class="imc-tags">${tags}</div>
                        </div>
                        <button class="btn-book-imc" style="width:auto; padding:8px 15px;" 
                           onclick="bookIMC('${dayData.fullLabel}', '${slot.time}', '${escape(pkg.detail)}')">
                           จองคิว
                        </button>
                    </div>
                    <div style="margin-top:10px;">
                        <div class="imc-detail">${pkg.detail}</div>
                    </div>
                </div>
                `;
            });
        });

        if (foundCount === 0) {
            html = `<div style="text-align:center;padding:40px;color:#cbd5e1"><i class="fas fa-filter"></i><br>ไม่พบรายการตามเงื่อนไข</div>`;
        }

        area.innerHTML = html;
    }

    function bookIMC(dateStr, timeStr, detailEnc) {
        let detail = unescape(detailEnc);
        
        // เปิด Modal จอง
        // ใช้ฟังก์ชัน openBooking เดิม แต่ปรับแต่งข้อมูล
        try {
            bookingData = { 
                dept: "IMC Clinic", 
                date: dateStr, 
                time: timeStr, 
                is2Hr: false,
                service: "IMC Package (ต่อเนื่อง)",
                staff: "IMC Team" 
            };
            
            // Reset Form
            document.getElementById('inp-name').value = '';
            document.getElementById('inp-tel').value = '';
            document.getElementById('inp-note').value = detail; // ** ใส่ข้อความยาวๆ ลงใน Note อัตโนมัติ **
            
            // Hide specific fields
            document.getElementById('normal-fields').classList.add('hidden');
            document.getElementById('postpartum-fields').classList.add('hidden');
            document.getElementById('steam-fields').classList.add('hidden');
            document.getElementById('price-tag').style.display = 'none';

            loadUserData();
            switchStep('step-form');
            document.getElementById('bookingModal').classList.add('show');

        } catch(e) { console.error(e); }
    }

    // แก้ไขฟังก์ชัน renderApp ให้รองรับ logic ใหม่
    function renderApp(data, userObj) {
      if (currentApp !== userObj) return;

      if (userObj === 'imc') {
          // สำหรับ IMC ใช้ Data โดยตรงจาก getIMCData()
          globalData = data.imc; // แก้ไขให้ Backend ส่ง imc: getIMCData() มาใน struct
      } else {
          globalData = data;
      }
      
      renderScroller();
      
      if (userObj === 'imc') {
          renderIMCTable(selectedIndex);
      } else {
          renderSlots(selectedIndex);
      }
    }

</script>
