<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>จองคิวออนไลน์ รพ.สะเดา</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    /* =========================================
       1. CSS VARIABLES & RESET
       ========================================= */
    :root { 
        /* Main Theme Colors */
        --primary: #2e7d32; 
        --primary-dark: #1b5e20; 
        --bg-color: #f8fafc; 
        --radius: 20px; 
        
        /* Shadows */
        --shadow-sm: 0 4px 6px -1px rgba(0,0,0,0.05); 
        --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.08); 
        
        /* Wellness Theme */
        --wellness-primary: #D4AF37; 
        --wellness-dark: #AA8C2C;
        --wellness-text: #423818;

        /* IMC Theme (สีม่วง) */
        --imc-primary: #9c27b0; 
        --imc-dark: #7b1fa2;
        --imc-bg: #f3e5f5;

        /* Rights & Status Colors */
        --positive: #166534; 
        --positive-bg: #dcfce7; 
        --positive-border: #bbf7d0;

        --negative: #991b1b; 
        --negative-bg: #fee2e2; 
        --negative-border: #fecaca;
    }

    * { 
        box-sizing: border-box; 
        -webkit-tap-highlight-color: transparent; 
    }

    body { 
        font-family: 'Prompt', sans-serif; 
        background-color: var(--bg-color); 
        margin: 0; 
        padding: 0; 
        min-height: 100vh; 
        color: #333; 
        position: relative; 
        overflow-x: hidden; 
    }

    body::before { 
        content: ""; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: url('https://img5.pic.in.th/file/secure-sv1/52083c99d955995f60b4a9dd8448920a.png') no-repeat center center; 
        background-size: cover; 
        opacity: 0.04; 
        z-index: -1; 
        filter: grayscale(50%); 
        pointer-events: none; 
    }

    .hidden { 
        display: none !important; 
    }

    .fade-in { 
        animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
    }

    /* =========================================
       2. COMPONENTS
       ========================================= */
    
    /* Language Toggle Button */
    .lang-btn { 
        position: fixed; 
        top: 15px; 
        right: 15px; 
        z-index: 9999; 
        background: rgba(255, 255, 255, 0.9); 
        border: 2px solid var(--primary); 
        color: var(--primary); 
        padding: 5px 12px; 
        border-radius: 20px; 
        font-weight: bold; 
        font-family: 'Prompt'; 
        cursor: pointer; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        display: flex; 
        align-items: center; 
        gap: 5px; 
        transition: all 0.2s;
    }
    .lang-btn:hover { 
        background: var(--primary); 
        color: white; 
    }
    .lang-btn img {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        object-fit: cover;
    }

    /* =========================================
       3. HOME LAYOUT
       ========================================= */
    .home-container { 
        max-width: 600px; 
        margin: 0 auto; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        min-height: 100vh; 
        padding-bottom: 40px; 
    }

    .hero-banner { 
        width: 100%; 
        height: 260px; 
        background-image: url('https://img2.pic.in.th/pic/2e56ebb3c838125fd55c9db5dcd51baf.png'); 
        background-size: cover; 
        background-position: center; 
        position: relative; 
        border-radius: 0 0 30px 30px; 
        overflow: hidden; 
        box-shadow: var(--shadow-md); 
        margin-bottom: -40px; 
        z-index: 1; 
    }

    .hero-overlay { 
        position: absolute; 
        inset: 0; 
        background: linear-gradient(to bottom, rgba(46,125,50,0.3), rgba(27,94,32,0.85)); 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        padding: 20px; 
        text-align: center; 
        color: white; 
        backdrop-filter: blur(1px); 
    }

    .main-logo { 
        width: 80px; 
        height: 80px; 
        object-fit: contain; 
        margin-bottom: 10px; 
        background: white; 
        border-radius: 50%; 
        padding: 2px; 
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    }

    .home-title h1 { 
        font-size: 1.4rem; 
        font-weight: 700; 
        margin: 5px 0 10px; 
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .status-pill { 
        background: rgba(255,255,255,0.2); 
        padding: 6px 16px; 
        border-radius: 20px; 
        font-size: 0.8rem; 
        border: 1px solid rgba(255,255,255,0.3); 
        display: flex; 
        align-items: center; 
        gap: 6px; 
        backdrop-filter: blur(4px);
    }
    
    .menu-container { 
        width: 100%; 
        padding: 0 20px; 
        z-index: 2; 
    }

    /* Dept Cards */
    .dept-card { 
        background: white; 
        border-radius: var(--radius); 
        padding: 20px; 
        margin-bottom: 15px; 
        display: flex; 
        align-items: center; 
        cursor: pointer; 
        box-shadow: var(--shadow-sm); 
        border-left: 6px solid #ccc; 
        position: relative; 
        overflow: hidden; 
        transition: transform 0.2s; 
    }
    .dept-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
    .dept-card:active { transform: scale(0.98); }
    .dept-card::after { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
    
    .card-ttm::after { background: #2e7d32; }
    .card-tcm::after { background: #e53935; }
    .card-postpartum::after { background: #ec4899; }
    .card-steam::after { background: #0288d1; }
    
    .card-wellness { border: 1px solid #F8E79B; background: linear-gradient(135deg, #fff 50%, #fffcf2 100%); }
    .card-wellness::after { background: linear-gradient(to bottom, #D4AF37, #AA8C2C); }
    .card-wellness h3 { color: #AA8C2C !important; }

    /* IMC Card Specifics */
    .card-imc { border-left-color: var(--imc-primary); }
    .card-imc::after { background: var(--imc-primary); }
    .card-imc:hover .arrow-btn { background: var(--imc-primary); color:white; }
    
    .dept-icon { 
        width: 55px; 
        height: 55px; 
        border-radius: 50%; 
        margin-right: 15px; 
        object-fit: cover; 
        border: 3px solid #f1f5f9; 
    }
    
    .dept-info h3 { 
        margin: 0 0 4px 0; 
        font-size: 1.1rem; 
        font-weight: 700; 
        color: #1e293b; 
    }
    .dept-info p { 
        margin: 0; 
        font-size: 0.85rem; 
        color: #64748b; 
        line-height: 1.3; 
    }
    
    .arrow-btn { 
        margin-left: auto; 
        width: 32px; 
        height: 32px; 
        border-radius: 50%; 
        background: #f8fafc; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        color: #94a3b8; 
    }

    .info-card { 
        margin-top: 20px; 
        background: white; 
        border-radius: var(--radius); 
        overflow: hidden; 
        box-shadow: var(--shadow-sm); 
        border: 1px solid #e2e8f0; 
    }
    .info-img { width: 100%; height: 160px; object-fit: cover; }
    .info-content { padding: 15px 20px; }
    .info-content h4 { margin: 0 0 5px; color: #1e293b; font-size: 1rem; }
    .info-content p { margin: 0; color: #64748b; font-size: 0.85rem; }

    /* =========================================
       4. DASHBOARD VIEW
       ========================================= */
    .top-section { 
        background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
        color: white; 
        padding: 15px 15px 25px 15px; 
        position: sticky; 
        top: 0; 
        z-index: 100; 
        border-radius: 0 0 30px 30px; 
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3); 
        transition: background 0.5s ease;
    }
    
    .back-btn { 
        position: absolute; 
        top: 15px; 
        left: 15px; 
        background: rgba(255,255,255,0.2); 
        width: 38px; 
        height: 38px; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        cursor: pointer; 
        backdrop-filter: blur(4px);
    }
    
    .header-content { 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 12px; 
        margin-bottom: 8px; 
        margin-top: 5px; 
    }
    
    .app-logo { 
        width: 50px; 
        height: 50px; 
        border-radius: 50%; 
        border: 2px solid rgba(255,255,255,0.9); 
        background: white; 
        object-fit:contain; 
    }
    
    .live-clock { 
        text-align: center; 
        background: rgba(0,0,0,0.15); 
        border-radius: 20px; 
        padding: 4px 14px; 
        font-size: 0.8rem; 
        margin: 10px auto 15px; 
        width: fit-content; 
        display: flex; 
        gap: 6px; 
        align-items: center; 
        border: 1px solid rgba(255,255,255,0.2); 
        backdrop-filter: blur(4px);
    }
    
    .date-scroller { 
        display: flex; 
        overflow-x: auto; 
        padding-bottom: 5px; 
        gap: 10px; 
        scrollbar-width: none; 
        margin: 0 5px; 
    }
    
    .date-chip { 
        --day-color: #555; 
        background: rgba(255,255,255,0.15); 
        color: white; 
        border-radius: 16px; 
        padding: 10px 0; 
        min-width: 65px; 
        text-align: center; 
        cursor: pointer; 
        border: 1px solid rgba(255,255,255,0.1); 
        flex-shrink: 0; 
        transition: 0.3s; 
        backdrop-filter: blur(4px);
    }
    
    .date-chip small { font-size: 0.75rem; display: block; margin-bottom: 4px; opacity: 0.9; }
    .date-chip span { font-size: 1.2rem; display: block; line-height: 1; font-weight: 700; }
    
    .date-chip.active { 
        background: white; 
        color: var(--day-color); 
        transform: scale(1.1); 
        font-weight: bold; 
        border: none; 
        box-shadow: 0 8px 20px rgba(0,0,0,0.25); 
    }
    .date-chip.active::after { 
        content:''; 
        position: absolute; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        height: 4px; 
        background: var(--day-color); 
    }
    
    /* FIX: IMC Date Scroller Style */
    #imc-date-scroller .date-chip.active { color: var(--imc-primary) !important; }

    .container { max-width: 600px; margin: 0 auto; padding: 0 15px 80px; }
    
    .selected-date-header { 
        font-size: 1.1rem; 
        font-weight: 700; 
        color: #334155; 
        padding: 25px 5px 15px; 
        display: flex; 
        align-items: center; 
    }
    .header-bar { width: 6px; height: 24px; border-radius: 4px; margin-right: 12px; background-color: var(--primary); }
    .grid-container { display: flex; flex-direction: column; gap: 14px; }
    
    /* Slot Card (Original) */
    .slot-card { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        background: white; 
        border-radius: 18px; 
        padding: 18px 20px; 
        box-shadow: var(--shadow-sm); 
        border: 1px solid #f1f5f9; 
        position: relative; 
        overflow: hidden; 
        margin-bottom:12px; 
        opacity: 0; 
        animation: slideUp 0.3s ease-out forwards; 
    }
    .slot-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
    .is-available::before { background: #4caf50; } 
    .is-full::before { background: #ef4444; }
    
    .status-badge { 
        padding: 6px 16px; 
        border-radius: 20px; 
        font-size: 0.9rem; 
        font-weight: 600; 
        min-width: 70px; 
        text-align: center; 
    }
    .bg-av { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
    .bg-full { background: #fee2e2; color: #b71c1c; border: 1px solid #ffcdd2; }

    /* =========================================
       5. IMC SPECIFIC UI
       ========================================= */
    .imc-setup-box { 
        margin: -20px 15px 15px 15px; 
        background: white; 
        border-radius: 20px; 
        padding: 20px; 
        box-shadow: var(--shadow-md); 
        position: relative; 
        z-index: 10; 
        border: 1px solid #f3e5f5; 
    }
    
    .imc-toggle-group { 
        display: flex; 
        gap: 8px; 
        background: #f8fafc; 
        padding: 5px; 
        border-radius: 12px; 
        margin-bottom: 15px; 
    }
    
    .imc-toggle { 
        flex: 1; 
        text-align: center; 
        padding: 10px 5px; 
        border-radius: 10px; 
        cursor: pointer; 
        transition: 0.2s; 
        border: 1px solid transparent; 
    }
    .imc-toggle span { display: block; font-weight: 700; font-size: 0.9rem; }
    .imc-toggle small { font-size: 0.75rem; color: #666; }
    
    .imc-toggle.active { 
        background: white; 
        color: var(--imc-primary); 
        border-color: var(--imc-primary); 
        box-shadow: var(--shadow-sm); 
    }
    
    .imc-options { display: flex; justify-content: space-around; padding-top: 5px; }
    .imc-checkbox { display: flex; align-items: center; gap: 8px; font-weight: 500; color: #555; cursor: pointer; }
    .imc-checkbox input { accent-color: var(--imc-primary); width: 18px; height: 18px; }

    .imc-slot-card { 
        background: white; 
        border-radius: 16px; 
        padding: 15px; 
        margin-bottom: 12px; 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        border-left: 6px solid #ccc; 
        box-shadow: var(--shadow-sm); 
        transition: 0.2s; 
    }
    .imc-slot-card:active { transform: scale(0.98); }
    .imc-slot-card.available { border-left-color: #4caf50; }
    .imc-slot-card.full { border-left-color: #ff9800; background: #fffdf5; }
    
    .imc-time { font-size: 1.4rem; font-weight: 700; color: #333; }
    .imc-flow-badge { 
        background: #f3e5f5; 
        color: var(--imc-primary); 
        font-size: 0.75rem; 
        padding: 2px 8px; 
        border-radius: 4px; 
        display: inline-block; 
        margin-top: 4px; 
        font-weight: 500; 
    }
    
    .imc-btn { padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
    .imc-btn-book { background: var(--imc-bg); color: var(--imc-primary); }
    .imc-btn-full { background: #fff3e0; color: #ff9800; cursor: not-allowed; }

    /* Timeline in Modal */
    .timeline { 
        position: relative; 
        margin: 15px 0 25px 0; 
        padding-left: 20px; 
        border-left: 2px solid #e0e0e0; 
    }
    .timeline-item { position: relative; margin-bottom: 20px; }
    .timeline-item::before { 
        content: ''; 
        position: absolute; 
        left: -26px; 
        top: 6px; 
        width: 10px; 
        height: 10px; 
        border-radius: 50%; 
        background: var(--imc-primary); 
        border: 2px solid white; 
        box-shadow: 0 0 0 2px #f3e5f5; 
    }
    .timeline-time { font-weight: 700; color: #333; font-size: 1rem; }
    .timeline-desc { font-size: 0.9rem; color: #666; }
    .timeline-duration { font-size: 0.8rem; color: #999; margin-left: 5px; }

    /* =========================================
       6. RIGHTS BOX (NEW DESIGN)
       ========================================= */
    .rights-container { 
        border-radius: 12px; 
        overflow: hidden; 
        margin-bottom: 20px; 
        font-size: 0.85rem; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    }
    .rights-positive { 
        background-color: var(--positive-bg); 
        color: var(--positive); 
        padding: 12px; 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        font-weight: 600; 
        border-bottom: 1px solid #fff; 
    }
    .rights-negative { 
        background-color: var(--negative-bg); 
        color: var(--negative); 
        padding: 12px; 
    }
    .rights-negative b { font-weight: 700; text-decoration: underline; }
    .rights-negative ul { 
        margin: 5px 0 0 20px; 
        padding: 0; 
        font-size: 0.85rem; 
        opacity: 0.9; 
    }
    .rights-negative li { margin-bottom: 2px; }

    /* =========================================
       7. MODAL & FORM ELEMENTS
       ========================================= */
    .modal-overlay { 
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,0.6); 
        z-index: 1000; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        opacity: 0; 
        visibility: hidden; 
        transition: all 0.3s; 
        backdrop-filter: blur(5px); 
    }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    
    .modal-card { 
        background: white; 
        width: 90%; 
        max-width: 380px; 
        border-radius: 28px; 
        padding: 25px; 
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); 
        transform: translateY(20px); 
        transition: all 0.3s; 
        max-height: 90vh; 
        overflow-y: auto; 
    }
    .modal-overlay.show .modal-card { transform: translateY(0); }
    
    .modal-header { 
        font-size: 1.2rem; 
        font-weight: 700; 
        margin-bottom: 20px; 
        color: var(--primary); 
        border-bottom: 2px solid #f1f5f9; 
        padding-bottom: 15px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }
    
    .form-group { margin-bottom: 20px; position: relative; }
    .form-label { display: block; margin-bottom: 8px; font-size: 0.95rem; color: #334155; font-weight: 600; }
    
    .form-control { 
        width: 100%; 
        padding: 14px; 
        border: 1px solid #cbd5e1; 
        border-radius: 14px; 
        font-family: 'Prompt'; 
        font-size: 1rem; 
        background: #f8fafc; 
        margin-bottom: 15px; 
        outline: none; 
    }
    .form-control:focus { 
        border-color: var(--primary); 
        background: white; 
        box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1); 
    }
    
    .btn { 
        width: 100%; 
        padding: 14px; 
        border: none; 
        border-radius: 14px; 
        font-size: 1rem; 
        cursor: pointer; 
        font-weight: 600; 
        font-family: 'Prompt'; 
    }
    .btn-confirm { background: var(--primary); color: white; }
    .btn-cancel { background: #f1f5f9; color: #64748b; margin-top: 10px; }

    /* Autocomplete */
    .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #cbd5e1; border-radius: 0 0 14px 14px; max-height: 160px; overflow-y: auto; z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.1); display: none; }
    .autocomplete-item { padding: 10px 14px; cursor: pointer; font-size: 0.95rem; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 8px; }
    
    /* Animations */
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Helper Classes */
    .gender-male { background: #e3f2fd !important; border-color: #90caf9 !important; }
    .gender-male::before { background: #1976d2 !important; }
    .gender-male .icon-status { background: #bbdefb !important; color: #1565c0 !important; }
    .gender-female { background: #fce4ec !important; border-color: #f48fb1 !important; }
    .gender-female::before { background: #d81b60 !important; }
    .gender-female .icon-status { background: #f8bbd0 !important; color: #ad1457 !important; }
    .time-wrap { display: flex; align-items: center; gap: 16px; }
    .icon-status { width: 44px; height: 44px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
  </style>
</head>
<body>

  <button class="lang-btn" onclick="toggleLanguage()">
    <i class="fas fa-globe"></i> <span id="lang-text">TH</span>
  </button>

  <div id="view-home" class="home-container fade-in">
    <div class="hero-banner">
        <div class="hero-overlay">
            <img src="https://img2.pic.in.th/pic/6f7b352408393a1295f3000e7d9e6754.md.png" class="main-logo">
            <div class="home-title">
                <h2 data-i18n="dept_ttm_alt">กลุ่มงานการแพทย์แผนไทยและการแพทย์ทางเลือก</h2>
                <h1 data-i18n="hospital_name">โรงพยาบาลสะเดา</h1>
                <div class="status-pill"><i class="fas fa-circle" style="color:#4caf50; font-size:0.6rem;"></i> <span data-i18n="online_24">ระบบออนไลน์ 24 ชม.</span></div>
            </div>
        </div>
    </div>

    <div class="menu-container">
        <div class="dept-card card-ttm" onclick="openApp('ttm')">
          <img src="https://img2.pic.in.th/pic/619e72dc2124132ccf4620717d4fa58d.md.png" class="dept-icon">
          <div class="dept-info"><h3 data-i18n="ttm_title">แพทย์แผนไทย</h3><p data-i18n="ttm_desc">นวดรักษา, ประคบ, นวดส่งเสริมฯ</p></div>
          <div class="arrow-btn"><i class="fas fa-chevron-right"></i></div>
        </div>
        <div class="dept-card card-tcm" onclick="openApp('tcm')">
          <img src="https://img2.pic.in.th/pic/--06d2d95efaba2074.md.png" class="dept-icon">
          <div class="dept-info"><h3 data-i18n="tcm_title">แพทย์แผนจีน</h3><p data-i18n="tcm_desc">ฝังเข็ม, ครอบแก้ว, ฝังเข็มใบหน้า</p></div>
          <div class="arrow-btn"><i class="fas fa-chevron-right"></i></div>
        </div>
        <div class="dept-card card-postpartum" onclick="openApp('postpartum')">
          <img src="https://img2.pic.in.th/pic/eb06897c542c79b64690c8e794fa84a4.png" class="dept-icon">
          <div class="dept-info"><h3 data-i18n="pp_title">บริการหลังคลอด</h3><p data-i18n="pp_desc">หลังคลอดธรรมชาติ 7 วัน / หลังผ่า 1 เดือน</p></div>
          <div class="arrow-btn"><i class="fas fa-chevron-right"></i></div>
        </div>
        <div class="dept-card card-steam" onclick="openApp('steam')">
          <img src="https://img2.pic.in.th/pic/-3b445847427fcbfd.png" class="dept-icon">
          <div class="dept-info"><h3 data-i18n="steam_title">อบไอน้ำสมุนไพร</h3><p data-i18n="steam_desc">ช่วยการไหลเวียนโลหิต ภูมิแพ้ นอนไม่หลับ</p></div>
          <div class="arrow-btn"><i class="fas fa-chevron-right"></i></div>
        </div>
        <div class="dept-card card-wellness" onclick="openApp('wellness')">
            <img src="https://img2.pic.in.th/pic/Wellness-logo.png" class="dept-icon" style="background:white; padding:2px;">
            <div class="dept-info"><h3>Wellness Clinic</h3><p data-i18n="well_desc">สครับเกลือ, สปาผิว, นวดอโรม่า</p></div>
            <div class="arrow-btn"><i class="fas fa-chevron-right"></i></div>
        </div>
        
        <div class="dept-card card-imc" onclick="openIMCSetup()">
           <div style="width:60px; height:60px; background:#f3e5f5; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:20px; border:4px solid #f8fafc; color:var(--imc-primary); font-size:1.8rem;">
              <i class="fas fa-wheelchair"></i>
           </div>
           <div class="dept-info">
              <h3 data-i18n="imc_title">ฟื้นฟูสภาพกลุ่มผู้ป่วย IMC</h3>
              <p style="color:var(--imc-primary); font-size:0.8rem;" data-i18n="imc_desc">โรคหลอดเลือดสมอง Stroke ไม่เกิน 6 เดือน (นับจากวันเริ่มฟื้นฟู)</p>
           </div>
           <div class="arrow-btn"><i class="fas fa-chevron-right"></i></div>
        </div>

        <div class="info-card">
            <img src="https://img5.pic.in.th/file/secure-sv1/d26f2357c0618da568d3dcf464837fda.png" class="info-img">
            <div class="info-content">
                <h4><i class="fas fa-hospital-alt" style="color:#2e7d32;"></i> <span data-i18n="building_info">ตึกอุบัติเหตุ 4 ชั้น (ตึกมรกต)</span></h4>
                <p data-i18n="floor_info">สถานที่ให้บริการแพทย์แผนไทย ชั้น 4</p>
            </div>
        </div>
    </div>
  </div>

  <div id="view-dashboard" class="hidden">
    <div class="top-section">
      <div class="back-btn" onclick="goHome()"><i class="fas fa-arrow-left"></i></div>
      <div class="header-content">
        <img id="app-logo" src="" class="app-logo">
        <div class="header-titles"><h1 id="app-title"></h1><p><span data-i18n="sched_realtime">ตารางนัด</span> <span id="loadingIndicator" class="mini-loader" style="display:none;"><i class="fas fa-circle-notch fa-spin"></i></span></p></div>
      </div>
      <div id="liveClock" class="live-clock"><i class="far fa-clock"></i> <span>...</span></div>
      <div id="dateScroller" class="date-scroller"></div>
    </div>
    <div class="container">
      <div id="contentArea"></div>
      <div class="contact-section">
        <p style="font-weight:600; margin-bottom:15px; font-size:0.9rem; color:#64748b;" data-i18n="contact_channel">ติดต่อ</p>
        <div style="white-space:nowrap;">
          <a class="social-btn btn-fb"><i class="fab fa-facebook-f"></i></a>
          <a class="social-btn btn-line"><i class="fab fa-line"></i></a>
          <a class="social-btn btn-phone"><i class="fas fa-phone"></i></a>
        </div>
      </div>
    </div>
  </div>

  <div id="view-imc-setup" class="hidden">
      <div class="top-section" style="background: linear-gradient(135deg, var(--imc-primary), var(--imc-dark));">
          <div class="back-btn" onclick="closeIMC()"><i class="fas fa-arrow-left"></i></div>
          <div class="header-content">
             <div class="app-logo" style="background:#f3e5f5; display:flex; align-items:center; justify-content:center; color:var(--imc-primary); font-size:1.5rem;"><i class="fas fa-wheelchair"></i></div>
             <div class="header-titles"><h1 data-i18n="imc_title">ฟื้นฟูสภาพกลุ่มผู้ป่วย IMC</h1><p>ตารางนัดแบบบูรณาการ</p></div>
          </div>
          <div id="imc-date-scroller" class="date-scroller" style="margin-top:15px;"></div>
          <div id="selected-date-display" style="text-align:center; color:rgba(255,255,255,0.9); font-size:0.9rem; margin-top:5px;"></div>
      </div>
      
      <div class="container" style="padding-top:20px;">
          <div class="imc-setup-box">
              <div class="imc-toggle-group">
                  <div id="pt-1.5" class="imc-toggle active" onclick="changePT(1.5)"><span>กายภาพ</span><small>1.5 ชม.</small></div>
                  <div id="pt-1" class="imc-toggle" onclick="changePT(1)"><span>กายภาพ</span><small>1.0 ชม.</small></div>
                  <div id="pt-0" class="imc-toggle" onclick="changePT(0)"><span>ไม่ทำ</span><small>กายภาพ</small></div>
              </div>
              <div class="imc-options">
                  <label class="imc-checkbox"><input type="checkbox" id="chk_ttm" checked onchange="searchIMCSlots()"> +นวดไทย</label>
                  <label class="imc-checkbox"><input type="checkbox" id="chk_tcm" checked onchange="searchIMCSlots()"> +ฝังเข็ม</label>
              </div>
          </div>
          <div id="imc-results" style="padding:0 10px;"></div>
      </div>
  </div>

  <div id="bookingModal" class="modal-overlay">
    <div class="modal-card">
      <div id="step-form">
        <div class="modal-header">
            <span><i class="fas fa-edit"></i> <span data-i18n="form_title">กรอกข้อมูล</span></span>
            <button id="btn-use-old" class="btn-autofill" onclick="fillUserData()"><i class="fas fa-history"></i> <span data-i18n="use_old_data">ประวัติเดิม</span></button>
        </div>

        <input type="text" id="inp-name" class="form-control" placeholder="ชื่อ-นามสกุล" autocomplete="off">
        <input type="tel" id="inp-tel" class="form-control" placeholder="เบอร์โทรศัพท์" autocomplete="off">
        
        <div id="normal-fields" class="hidden">
            <select id="inp-service" class="form-control" onchange="updatePriceDisplay()"></select>
            <div id="price-tag" style="margin-top:-10px; margin-bottom:15px; display:none;"><div style="background:#f0f9ff; color:#0369a1; padding:10px; border-radius:10px; font-size:0.9rem; border:1px solid #bae6fd;"><span id="price-val">-</span></div></div>
            <div id="group-staff" class="custom-select-wrapper hidden"><div class="custom-select" id="staff-trigger" onclick="toggleStaffDropdown()"><div class="select-selected"><img id="staff-display-img" class="select-img"><span id="staff-display-name">ไม่ระบุ</span></div><i class="fas fa-chevron-down"></i></div><div class="select-items" id="staff-options"></div></div><input type="hidden" id="inp-staff-val">
            <div id="box-option-2hr" class="option-2hr-container hidden"><label class="option-2hr-label"><input type="checkbox" id="inp-2hr" class="chk-2hr"> <span><i class="fas fa-star" style="color:#f59e0b;"></i> <span data-i18n="book_2hr">จอง 2 ชม.</span></span></label></div>
        </div>

        <div id="postpartum-fields" class="hidden">
            <input type="date" id="inp-birth-date" class="form-control">
            <select id="inp-delivery-type" class="form-control"><option value="คลอดเอง">คลอดเอง</option><option value="ผ่าคลอด">ผ่าคลอด</option></select>
            <input type="text" id="inp-hospital" class="form-control" placeholder="รพ.ที่คลอด">
        </div>

        <div id="steam-fields" class="hidden">
           <select id="inp-gender" class="form-control"><option value="หญิง">หญิง</option><option value="ชาย">ชาย</option></select>
           <div id="extra-patients-container"></div>
           <button type="button" class="btn-add-patient" onclick="addPatient()">+ เพิ่มผู้รับบริการ</button>
        </div>

        <div id="imc-fields" class="hidden">
            <div style="background:#f3e5f5; padding:15px; border-radius:12px; border:1px solid #e1bee7; margin-bottom:20px;">
                <label style="color:var(--imc-primary); font-weight:bold; display:block; margin-bottom:10px;">แผนการรักษา:</label>
                <div class="timeline" id="imc-timeline"></div>
            </div>
            
            <div class="rights-container">
                <div class="rights-positive">
                    <i class="fas fa-check-circle"></i> เบิกได้ตามสิทธิรักษา
                </div>
                <div class="rights-negative">
                    <i class="fas fa-exclamation-circle"></i> <b>ยกเว้น สิทธิประกันสังคม</b>
                    <ul>
                        <li>นวดและประคบเพื่อการฟื้นฟู 250 บาท</li>
                        <li>ฝังเข็ม 150 - 200 บาท</li>
                    </ul>
                </div>
            </div>
        </div>

        <textarea id="inp-note" class="form-control" placeholder="หมายเหตุ (ถ้ามี)"></textarea>

        <div class="btn-group">
          <button class="btn btn-cancel" onclick="closeModal()" data-i18n="btn_cancel">ยกเลิก</button>
          <button class="btn btn-confirm" onclick="goToSummary()" data-i18n="btn_save">ยืนยันการจอง</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ⚠️ CONFIGURATION
    const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbxMVqlYGeuj75wQm41kZCD4wf2weZajj27b0omuC6HlHzWja4sJYz6HF6m5b5nlmSUMtw/exec";
    const LINE_OA_ID = "@649dqeft";
    
    let currentLang = 'th';
    let currentApp = ''; 
    let globalData = [];
    let bookingData = {};
    let refreshInterval, selectedIndex = 0, isFetching = false;
    let nextSlotStaffList = [], currentSlotCapacity = 0, patientCount = 1;
    let currentPT = 1.5, selectedDateStr = "";

    const SafeStorage = {
        getItem: function(key) { try { return localStorage.getItem(key); } catch(e) { return null; } },
        setItem: function(key, val) { try { localStorage.setItem(key, val); } catch(e) { } }
    };

    const translations = {
        th: {
            dept_ttm_alt: "กลุ่มงานการแพทย์แผนไทยและการแพทย์ทางเลือก", hospital_name: "โรงพยาบาลสะเดา", online_24: "ระบบออนไลน์ 24 ชม.",
            ttm_title: "แพทย์แผนไทย", ttm_desc: "นวดรักษา, ประคบ, นวดส่งเสริมฯ",
            tcm_title: "แพทย์แผนจีน", tcm_desc: "ฝังเข็ม, ครอบแก้ว, ฝังเข็มใบหน้า",
            pp_title: "บริการหลังคลอด", pp_desc: "หลังคลอดธรรมชาติ 7 วัน / หลังผ่า 1 เดือน",
            steam_title: "อบไอน้ำสมุนไพร", steam_desc: "ช่วยการไหลเวียนโลหิต ภูมิแพ้ นอนไม่หลับ",
            well_desc: "สครับเกลือ, สปาผิว, นวดอโรม่า",
            imc_title: "ฟื้นฟูสภาพกลุ่มผู้ป่วย IMC", imc_desc: "โรคหลอดเลือดสมอง Stroke ไม่เกิน 6 เดือน (นับจากวันเริ่มฟื้นฟู)",
            building_info: "ตึกอุบัติเหตุ 4 ชั้น (ตึกมรกต)", floor_info: "สถานที่ให้บริการแพทย์แผนไทย ชั้น 4",
            sched_realtime: "ตารางนัด (Real-time)", contact_channel: "ช่องทางติดต่อ",
            form_title: "กรอกข้อมูลจองคิว", use_old_data: "ประวัติเดิม", lbl_name: "ชื่อ-นามสกุล", lbl_tel: "เบอร์โทรศัพท์",
            lbl_service: "เลือกบริการ", rate_rights: "อัตราค่าบริการ/สิทธิ:", lbl_provider: "ผู้ให้บริการ",
            unspecified: "ไม่ระบุ", unspecified_any: "ไม่ระบุ (ใครก็ได้)", book_2hr: "จอง 2 ชม.", note_2hr: "*ชั่วโมงที่ 2 +200 บาท",
            lbl_birthdate: "วันเกิดลูก", lbl_delivery_type: "วิธีคลอด", lbl_hospital: "รพ.ที่คลอด",
            lbl_gender: "เพศ", lbl_extra_patient: "ผู้รับบริการเพิ่มเติม", btn_add_patient: "เพิ่มผู้รับบริการ",
            limit_patient: "เต็มแล้ว", lbl_note: "หมายเหตุ", btn_cancel: "ยกเลิก", btn_save: "ยืนยัน",
            avail: "ว่าง", full: "เต็ม", queue: "คิว", no_service: "งด", round_m: "ชาย", round_f: "หญิง",
            loading: "กำลังโหลด...", warning_msg: "คิวจะสมบูรณ์เมื่อแอดมินตอบรับทางไลน์"
        },
        en: {
            dept_ttm_alt: "Thai Traditional & Alternative Medicine", hospital_name: "Sadao Hospital", online_24: "Online System 24 hrs.",
            ttm_title: "Thai Traditional Medicine", ttm_desc: "Treatment Massage, Compress",
            tcm_title: "Chinese Medicine", tcm_desc: "Acupuncture, Cupping",
            pp_title: "Postpartum Care", pp_desc: "Mother Care",
            steam_title: "Herbal Steam", steam_desc: "Circulation, Allergy",
            well_desc: "Salt Scrub, Spa, Aroma",
            imc_title: "IMC Rehabilitation", imc_desc: "Stroke patients < 6 months",
            building_info: "Emerald Bldg 4th Fl.", floor_info: "Service Location: 4th Floor",
            sched_realtime: "Schedule", contact_channel: "Contact",
            form_title: "Booking Form", use_old_data: "History", lbl_name: "Full Name", lbl_tel: "Phone",
            lbl_service: "Service", rate_rights: "Fee:", lbl_provider: "Provider",
            unspecified: "Unspecified", unspecified_any: "Any", book_2hr: "2 Hours", note_2hr: "*+200 THB",
            lbl_birthdate: "Birth Date", lbl_delivery_type: "Delivery Type", lbl_hospital: "Hospital",
            lbl_gender: "Gender", lbl_extra_patient: "Extra Patients", btn_add_patient: "Add",
            limit_patient: "Full", lbl_note: "Note", btn_cancel: "Cancel", btn_save: "Confirm",
            avail: "Avail", full: "Full", queue: "Q", no_service: "Closed", round_m: "Male", round_f: "Female",
            loading: "Loading...", warning_msg: "Booking confirmed via LINE reply only."
        }
    };

    function t(key) { return translations[currentLang][key] || key; }
    function toggleLanguage() {
        currentLang = (currentLang === 'th') ? 'en' : 'th';
        document.getElementById('lang-text').innerText = currentLang.toUpperCase();
        document.querySelectorAll('[data-i18n]').forEach(el => { el.innerHTML = t(el.getAttribute('data-i18n')); });
        if (currentApp && APP_CONFIG[currentApp]) document.getElementById('app-title').innerText = (currentLang === 'en') ? APP_CONFIG[currentApp].titleEn : APP_CONFIG[currentApp].title;
        if (!document.getElementById('view-dashboard').classList.contains('hidden') && globalData.length > 0) { renderScroller(); renderSlots(selectedIndex); }
    }

    const APP_CONFIG = {
      ttm: { title: "แพทย์แผนไทย", titleEn: "Thai Traditional Medicine", logo: "https://img2.pic.in.th/pic/6f7b352408393a1295f3000e7d9e6754.md.png", color: "#2e7d32", dark: "#1b5e20", func: "getTTMData" },
      tcm: { title: "แพทย์แผนจีน", titleEn: "Chinese Medicine", logo: "https://img2.pic.in.th/pic/--06d2d95efaba2074.md.png", color: "#e53935", dark: "#b71c1c", func: "getTCMData" },
      postpartum: { title: "บริการหลังคลอด", titleEn: "Postpartum Care", logo: "https://img2.pic.in.th/pic/eb06897c542c79b64690c8e794fa84a4.png", color: "#ec4899", dark: "#be185d", func: "getPostpartumData" },
      steam: { title: "อบไอน้ำสมุนไพร", titleEn: "Herbal Steam", logo: "https://img2.pic.in.th/pic/-3b445847427fcbfd.png", color: "#0288d1", dark: "#01579b", func: "getSteamData" },
      wellness: { title: "Wellness Clinic", titleEn: "Wellness Clinic", logo: "https://img2.pic.in.th/pic/Wellness-logo.png", color: "#D4AF37", dark: "#AA8C2C", func: "getWellnessData" },
      imc: { title: "ฟื้นฟูสภาพกลุ่มผู้ป่วย IMC", titleEn: "IMC Rehabilitation", logo: "https://img2.pic.in.th/pic/6f7b352408393a1295f3000e7d9e6754.md.png", color: "#9c27b0", dark: "#7b1fa2", func: "" }
    };

    const STAFF_NAME_MAP_EN = { "รจนา M":"Rotjana (Maam)", "อรรถพล B":"Attapon (Bao)", "ศินารัตน์ C":"Sinarat (C)", "จุฑามาศ F":"Jutamat (Fon)", "ณิชาภัทร W":"Nichapat (Wawa)", "นิกษ์นิภา T":"Niknipha (Kartoon)", "รัตน์ชนก KW":"Ratchanok (Kwang)", "จินดา J":"Jinda (Jeab)" };
    const DEFAULT_IMG = "https://img2.pic.in.th/pic/1c189d2a727f532d391a5ab0604ccd2f.png";
    const STAFF_IMAGES = { "รจนา M": "https://img2.pic.in.th/pic/-b38b682db8ac596b.png", "อรรถพล B": "https://img5.pic.in.th/file/secure-sv1/6b74e1ebb096c81368605ff43948dab4.png", "ศินารัตน์ C": "https://img2.pic.in.th/pic/-df4e3c6f4a4b331f.png", "จุฑามาศ F": "https://img5.pic.in.th/file/secure-sv1/709dfc05071615eaaf008ea63d1e037e.png", "รัตน์ชนก KW": "https://img2.pic.in.th/pic/-83673d6d528be12a.png", "นิกษ์นิภา T": "https://img5.pic.in.th/file/secure-sv1/-c4fe207fa6c04aa3.png", "ณิชาภัทร W": "https://img2.pic.in.th/pic/1ef0aa325ccac37724897c9f2c10e5f4.png", "จินดา J": "https://img2.pic.in.th/pic/93b060e9e4b3fc9a9070d5ac2768c879.png" };
    const DAY_COLORS = [ "#FF5252", "#FFD740", "#E040FB", "#4CAF50", "#FF9800", "#2196F3", "#9C27B0" ];
    const SERVICE_PRICES_EN = { ttm:{"Treatment Massage":"Reimbursable"}, wellness:{"Salt Scrub":"500.-"} }; 

    function startClock() { setInterval(() => { let d=new Date(); let s=d.toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'numeric'}); if(currentLang==='th') s=s.replace(d.getFullYear(),d.getFullYear()+543); document.querySelector('#liveClock span').innerText=`${s} ${d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}`; },1000); }
    startClock();

    function openApp(type) {
      if(!APP_CONFIG[type]) return;
      currentApp = type;
      document.getElementById('view-home').classList.add('hidden');
      document.getElementById('view-dashboard').classList.remove('hidden');
      let conf = APP_CONFIG[type];
      document.documentElement.style.setProperty('--primary', conf.color);
      document.documentElement.style.setProperty('--primary-dark', conf.dark);
      document.getElementById('app-title').innerText = (currentLang==='en')?conf.titleEn:conf.title;
      document.getElementById('app-logo').src = conf.logo;
      selectedIndex = 0;
      fetchData(true);
      if(refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(()=>fetchData(false), 10000);
    }

    function goHome() {
      if(refreshInterval) clearInterval(refreshInterval);
      document.getElementById('view-dashboard').classList.add('hidden');
      document.getElementById('view-imc-setup').classList.add('hidden');
      document.getElementById('view-home').classList.remove('hidden');
      currentApp = '';
    }

    function fetchData(isFirstLoad) {
      if(isFetching) return; isFetching=true;
      if(isFirstLoad) document.getElementById('contentArea').innerHTML=`<div style="text-align:center;padding:50px;color:#999"><i class="fas fa-circle-notch fa-spin"></i> ${t('loading')}</div>`;
      else document.getElementById('loadingIndicator').classList.add('show');
      
      fetch(`${API_ENDPOINT}?action=${APP_CONFIG[currentApp].func}`)
        .then(r=>r.json()).then(d=>{ renderApp(d); document.getElementById('loadingIndicator').classList.remove('show'); isFetching=false; })
        .catch(e=>{ isFetching=false; });
    }

    function renderApp(data) {
      globalData = data; renderScroller(); renderSlots(selectedIndex);
    }

    function renderScroller() {
      let h=''; let days=["อา.","จ.","อ.","พ.","พฤ.","ศ.","ส."];
      globalData.forEach((d,i)=>{
         h+=`<div class="date-chip ${i===selectedIndex?'active':''}" style="--day-color:${DAY_COLORS[d.dayOfWeek]}" onclick="selectedIndex=${i};renderScroller();renderSlots(${i})"><small>${days[d.dayOfWeek]}</small><span>${d.displayDate.split(" ")[0]}</span></div>`;
      });
      document.getElementById('dateScroller').innerHTML=h;
    }

    function renderSlots(idx) {
      let day = globalData[idx];
      let html = `<div class="selected-date-header"><span class="header-bar" style="background-color:${DAY_COLORS[day.dayOfWeek]}"></span>${day.fullLabel}</div>`;
      if(day.status==='no_data') html+=`<div style="text-align:center;padding:40px;color:#ccc">${t('no_service')}</div>`;
      else {
         day.slots.forEach((s,i)=>{
             if(s.val==='งด') return;
             let isFull = s.val.includes('เต็ม');
             let statusTxt = isFull ? t('full') : `${t('avail')} ${s.count}`;
             let staffJson = JSON.stringify(s.staff||[]).replace(/"/g,"&quot;");
             let action = isFull ? '' : `onclick="openBooking('${s.time}','${day.displayDate}',${staffJson},${s.count},'${s.gender||''}')"`;
             html+=`<div class="slot-card ${isFull?'is-full':'is-available'}" ${action} style="animation-delay:${i*0.05}s">
                <div class="time-wrap"><div class="icon-status">${isFull?'<i class="fas fa-lock"></i>':'<i class="fas fa-leaf"></i>'}</div><div class="time-text">${s.time} น.</div></div>
                <div class="status-badge ${isFull?'bg-full':'bg-av'}">${statusTxt}</div>
             </div>`;
         });
      }
      document.getElementById('contentArea').innerHTML=html;
    }

    /* IMC LOGIC */
    function openIMCSetup() {
        currentApp = 'imc';
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-imc-setup').classList.remove('hidden');
        renderIMCDates(); changePT(1.5);
    }
    function closeIMC() {
        document.getElementById('view-imc-setup').classList.add('hidden');
        document.getElementById('view-home').classList.remove('hidden');
    }
    function renderIMCDates() {
        let h=''; let days=["อา.","จ.","อ.","พ.","พฤ.","ศ.","ส."]; let t=new Date();
        for(let i=0;i<14;i++){
            let d=new Date(); d.setDate(t.getDate()+i); let v=d.toISOString().split('T')[0];
            h+=`<div class="date-chip ${i===0?'active':''}" style="--day-color:#fff" onclick="selectIMCDate('${v}',this, d)"><small>${days[d.getDay()]}</small><span>${d.getDate()}</span></div>`;
            if(i===0) { selectedDateStr=v; document.getElementById('selected-date-display').innerText=`${d.getDate()} ${days[d.getDay()]}`; }
        }
        document.getElementById('imc-date-scroller').innerHTML=h;
    }
    function selectIMCDate(v,el,d) {
        selectedDateStr=v; 
        document.querySelectorAll('#imc-date-scroller .date-chip').forEach(c=>c.classList.remove('active')); el.classList.add('active');
        searchIMCSlots();
    }
    function changePT(v) { currentPT=v; document.querySelectorAll('.imc-toggle').forEach(b=>b.classList.remove('active')); document.getElementById('pt-'+v).classList.add('active'); searchIMCSlots(); }
    
    function searchIMCSlots() {
       let dObj=new Date(selectedDateStr);
       let m=["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];
       let dateThai = `${dObj.getDate()} ${m[dObj.getMonth()]}`;
       let needTTM=document.getElementById('chk_ttm').checked; let needTCM=document.getElementById('chk_tcm').checked;
       
       document.getElementById('imc-results').innerHTML=`<div style="text-align:center;padding:40px;color:#9c27b0"><i class="fas fa-circle-notch fa-spin"></i> Loading...</div>`;
       fetch(API_ENDPOINT, { method:'POST', body:JSON.stringify({ action:'checkIMC', date:dateThai, ptDuration:currentPT, needTTM:needTTM, needTCM:needTCM }) })
       .then(r=>r.json()).then(d=>{
           let h=''; 
           if(!d.slots||d.slots.length===0) h=`<div style="text-align:center;padding:40px;color:#ccc">ไม่พบรอบว่าง</div>`;
           else {
               d.slots.forEach(s=>{
                   let isAvail = s.status==='available';
                   let btn = isAvail ? `<div class="imc-btn imc-btn-book">จอง</div>` : `<div class="imc-btn imc-btn-full">เต็ม</div>`;
                   let click = isAvail ? `onclick='prepareIMCBooking(${JSON.stringify(s)})'` : '';
                   h+=`<div class="imc-slot-card ${s.status}" ${click}><div><div class="imc-time">${s.time} น.</div><div class="imc-flow-badge">${s.plan.flowType}</div></div>${btn}</div>`;
               });
           }
           document.getElementById('imc-results').innerHTML=h;
       });
    }

    function generateTimeline(s) {
        let html = '';
        const addMin = (timeStr, mins) => {
            let [h, m] = timeStr.split(':').map(Number);
            let date = new Date(); date.setHours(h, m, 0);
            date.setMinutes(date.getMinutes() + mins);
            return date.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
        };

        // 1. PT
        let currentTime = s.time;
        if(currentPT > 0) {
            let durMin = currentPT * 60;
            let endTime = addMin(currentTime, durMin);
            html += `<div class="timeline-item"><div class="timeline-time">${currentTime} - ${endTime} น.</div><div class="timeline-desc">กายภาพบำบัด <span style="font-size:0.8rem;color:#888;">(${currentPT} ชม.)</span></div></div>`;
            currentTime = endTime;
        }

        // 2. Parse Flow
        let flow = s.plan.flowType.split(" ➔ ").filter(f => !f.includes("กายภาพ"));
        flow.forEach(f => {
            let duration = (f.includes("นวด")) ? 60 : 30; // TTM=60, TCM=30
            let endTime = addMin(currentTime, duration);
            let label = (f.includes("นวด")) ? "แพทย์แผนไทย" : "แพทย์แผนจีน";
            html += `<div class="timeline-item"><div class="timeline-time">${currentTime} - ${endTime} น.</div><div class="timeline-desc">${label} <span style="font-size:0.8rem;color:#888;">(${duration} นาที)</span></div></div>`;
            currentTime = endTime;
        });
        
        return html;
    }

    function prepareIMCBooking(s) {
        currentApp = 'imc';
        bookingData = { date: document.getElementById('selected-date-display').innerText, time: s.time, service: "IMC Program" };
        bookingData.detail = s.plan.flowType + " (จบ " + s.plan.endTimeStr + " น.)";
        
        // Render Timeline
        document.getElementById('imc-timeline').innerHTML = generateTimeline(s);

        document.getElementById('bookingModal').classList.add('show');
        ['normal-fields','postpartum-fields','steam-fields'].forEach(id=>document.getElementById(id).classList.add('hidden'));
        document.getElementById('imc-fields').classList.remove('hidden');
    }

    /* GENERAL BOOKING */
    function openBooking(time, dateStr, staffList, count, gender) {
       bookingData = { date: dateStr, time: time };
       document.getElementById('bookingModal').classList.add('show');
       document.getElementById('normal-fields').classList.remove('hidden');
       ['postpartum-fields','steam-fields','imc-fields'].forEach(id=>document.getElementById(id).classList.add('hidden'));
       document.getElementById('box-option-2hr').classList.add('hidden');
       document.getElementById('price-tag').style.display='none';

       let sel = document.getElementById('inp-service'); sel.innerHTML='';
       if(currentApp==='ttm'||currentApp==='tcm') {
           ["นวดรักษา","นวดส่งเสริม","นวดเท้า"].forEach(s=>{ let o=document.createElement('option'); o.text=s; sel.add(o); }); 
           if(currentApp==='ttm') {
               document.getElementById('group-staff').classList.remove('hidden');
               let stSel=document.getElementById('staff-options'); stSel.innerHTML='';
               staffList.forEach(st=>{
                   let name = (currentLang==='en' && STAFF_NAME_MAP_EN[st]) ? STAFF_NAME_MAP_EN[st] : st;
                   let img = STAFF_IMAGES[st] || DEFAULT_IMG;
                   stSel.innerHTML+=`<div class="select-item" onclick="selectStaff('${name}','${img}')"><img src="${img}" class="item-img"><div class="item-text">${name}</div></div>`;
               });
               selectStaff(t('unspecified'), DEFAULT_IMG);
           } else document.getElementById('group-staff').classList.add('hidden');
       }
       if(currentApp==='postpartum') {
           document.getElementById('normal-fields').classList.add('hidden');
           document.getElementById('postpartum-fields').classList.remove('hidden');
       } else if (currentApp==='steam') {
           document.getElementById('normal-fields').classList.add('hidden');
           document.getElementById('steam-fields').classList.remove('hidden');
           currentSlotCapacity = count;
       } else if (currentApp==='wellness') {
           document.getElementById('group-staff').classList.add('hidden');
           ["สครับเกลือ","สปาผิว","นวดอโรม่า"].forEach(s=>{ let o=document.createElement('option'); o.text=s; sel.add(o); });
       }
       updatePriceDisplay();
    }

    function selectStaff(n,i) { document.getElementById('staff-display-name').innerText=n; document.getElementById('staff-display-img').src=i; document.getElementById('inp-staff-val').value=n; document.getElementById('staff-trigger').classList.remove('open'); }
    function toggleStaffDropdown() { document.getElementById('staff-trigger').classList.toggle('open'); }
    
    function updatePriceDisplay() {
        let s = document.getElementById('inp-service').value; let p='';
        if(currentApp==='wellness') { if(s.includes('สครับ')) p='500.-'; else if(s.includes('สปา')) p='650.-'; else p='550.-'; }
        if(p) { document.getElementById('price-tag').style.display='block'; document.getElementById('price-val').innerText=p; }
        else document.getElementById('price-tag').style.display='none';
    }

    function goToSummary() {
        let name = document.getElementById('inp-name').value;
        let tel = document.getElementById('inp-tel').value;
        if(!name) { Swal.fire({icon:'warning', title:'กรุณากรอกชื่อ', confirmButtonColor:'var(--primary)'}); return; }
        if(!tel) { Swal.fire({icon:'warning', title:'กรุณากรอกเบอร์โทร', confirmButtonColor:'var(--primary)'}); return; }
        
        let msg = `จองคิว: ${currentApp==='imc'?'IMC':currentApp.toUpperCase()}\nชื่อ: ${name}\nเบอร์: ${tel}\nวันที่: ${bookingData.date}\nเวลา: ${bookingData.time}`;
        if(currentApp==='imc') msg += `\nรายละเอียด:\n${bookingData.detail}`;
        
        Swal.fire({icon:'success', title:'คัดลอกแล้ว', text:'กำลังเปิดไลน์...', timer:1500, showConfirmButton:false}).then(()=>{
            let d=document.createElement("textarea"); d.value=msg; document.body.appendChild(d); d.select(); document.execCommand("copy"); document.body.removeChild(d);
            window.location.href=`https://line.me/R/oaMessage/${LINE_OA_ID}/?${encodeURIComponent(msg)}`;
        });
    }
    
    function closeModal() { document.getElementById('bookingModal').classList.remove('show'); }
    function addPatient() {
        if(patientCount>=currentSlotCapacity) { Swal.fire({icon:'info',text:'เต็มแล้ว'}); return; }
        patientCount++;
        let d = document.createElement('div'); d.className='extra-patient-item';
        d.innerHTML=`<div style="flex:1"><input class="form-control" placeholder="ชื่อคนที่ ${patientCount}"></div><button class="btn-remove" onclick="this.parentElement.remove();patientCount--"><i class="fas fa-trash"></i></button>`;
        document.getElementById('extra-patients-container').appendChild(d);
    }
    
    // Auto fill
    function fillUserData() {
        let h = JSON.parse(localStorage.getItem('ttm_booking_history')||"[]");
        if(h.length>0) { document.getElementById('inp-name').value=h[0].name; document.getElementById('inp-tel').value=h[0].tel; }
    }
  </script>
</body>
</html>
