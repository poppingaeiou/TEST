// ==========================================
// ‚öôÔ∏è CONFIGURATION
// ==========================================
var IMC_SHEET_ID = '1AqjtqinfBfyfpMllN-jvGJw_8RkVPMVLVVB-RL5Y8SE'; // ID ‡πÑ‡∏ü‡∏•‡πå IMC ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

// ==========================================
// üöÄ MAIN API (doPost)
// ==========================================
function doPost(e) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000); // ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏ß‡∏¥
    
    var data = JSON.parse(e.postData.contents);
    var result = {};

    // ‡πÅ‡∏¢‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° Action
    if (data.action === 'checkIMC') {
       result = checkIMCAvailability(data);
    } else if (data.action === 'bookIMC') {
       result = bookIMCQueue(data);
    } else {
       // ‡∏Å‡∏£‡∏ì‡∏µ Action ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
       result = { status: 'error', message: 'Unknown Action' };
    }

    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

// ==========================================
// üß† IMC LOGIC SYSTEM
// ==========================================

function checkIMCAvailability(data) {
  var ss = SpreadsheetApp.openById(IMC_SHEET_ID);
  var sheetTTM = ss.getSheetByName('TTM');
  var sheetTCM = ss.getSheetByName('TCM');

  if (!sheetTTM || !sheetTCM) {
    return { status: 'error', message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï TTM ‡∏´‡∏£‡∏∑‡∏≠ TCM ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á' };
  }

  // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å "‡∏ß‡∏±‡∏ô..‡∏ó‡∏µ‡πà 5 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2568" -> "5 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°" (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô Sheet)
  var searchDate = convertToSheetDate(data.date); 
  
  var ptDuration = parseFloat(data.ptDuration);
  var needTTM = data.needTTM;
  var needTCM = data.needTCM;
  
  var possibleStarts = ["08:30", "09:30", "13:00", "14:00"]; 
  var availableSlots = [];

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏£‡∏£‡∏≠‡πÑ‡∏ß‡πâ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Sheet ‡∏ö‡πà‡∏≠‡∏¢)
  var dataTTM = sheetTTM.getDataRange().getDisplayValues();
  var dataTCM = sheetTCM.getDataRange().getDisplayValues();

  for (var i = 0; i < possibleStarts.length; i++) {
    var start = possibleStarts[i];
    
    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤ Flow
    var plan = calculateIMCPlan(start, ptDuration, needTTM, needTCM);
    
    if (!plan.error) {
       var isAvailable = true;

       // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô TTM (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
       if (needTTM) {
          // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏ß‡∏•‡∏≤
          if (!checkSheetAvailability(dataTTM, searchDate, plan.ttmTime, 'TTM')) {
             isAvailable = false;
          }
       }
       
       // 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô TCM (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
       if (needTCM) {
          if (!checkSheetAvailability(dataTCM, searchDate, plan.tcmTime, 'TCM')) {
             isAvailable = false;
          }
       }

       if (isAvailable) {
         availableSlots.push({ time: start, plan: plan });
       }
    }
  }

  return { status: 'success', slots: availableSlots };
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏° ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Array ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
function checkSheetAvailability(dataRows, dateStr, timeStr, type) {
  // dataRows[row][0] = ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, dataRows[row][1] = ‡πÄ‡∏ß‡∏•‡∏≤
  for (var i = 0; i < dataRows.length; i++) {
    var rowDate = dataRows[i][0].trim();
    var rowTime = dataRows[i][1].trim(); // ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á format ‡πÄ‡∏ß‡∏•‡∏≤ 08:30 vs 8:30
    
    // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (‡∏•‡∏ö 0 ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå)
    if (cleanTime(rowTime) === cleanTime(timeStr) && rowDate === dateStr) {
        
        // ‡πÄ‡∏à‡∏≠‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡πâ‡∏ß! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á
        if (type === 'TCM') {
           // TCM ‡∏î‡∏π‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C (index 2) : ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á
           var val = dataRows[i][2];
           // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç > 0 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏ä‡πà "‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏ï‡πá‡∏°"/"‡∏á‡∏î"
           if (!isNaN(val) && parseInt(val) > 0) return true;
           return false;
        } 
        else if (type === 'TTM') {
           // TTM ‡∏î‡∏π‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå D ‡∏ñ‡∏∂‡∏á J (‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏≠) : index 3 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ
           // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏•‡∏Ç "1" ‡πÇ‡∏ú‡∏•‡πà‡∏°‡∏≤‡∏™‡∏±‡∏Å‡∏ä‡πà‡∏≠‡∏á ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
           for (var c = 3; c < dataRows[i].length; c++) {
              if (dataRows[i][c] == "1") return true;
           }
           return false;
        }
    }
  }
  return false; // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á
}

function calculateIMCPlan(startTime, ptDuration, needTTM, needTCM) {
  var startH = parseFloat(startTime.replace(":", "."));
  if (startTime.includes("30")) startH = parseInt(startTime.split(":")[0]) + 0.5;
  
  var ttmTime = null, tcmTime = null, endTime = 0, flowType = "";
  
  if (ptDuration === 1.5 && needTTM && needTCM) {
      tcmTime = addHours(startH, 1.0); 
      ttmTime = addHours(startH, 2.0); 
      endTime = startH + 3.0;
      flowType = "PT ‚ûî ‡∏à‡∏µ‡∏ô ‚ûî ‡πÑ‡∏ó‡∏¢";
  } 
  else if (ptDuration === 1.0 && needTTM && needTCM) {
      ttmTime = addHours(startH, 1.0);
      tcmTime = addHours(startH, 2.0);
      endTime = startH + 2.5;
      flowType = "PT ‚ûî ‡πÑ‡∏ó‡∏¢ ‚ûî ‡∏à‡∏µ‡∏ô";
  } 
  else {
      var gap = (ptDuration === 1.5) ? 0.5 : 0; 
      if (needTCM) {
         tcmTime = formatTime(startH + ptDuration + gap);
         endTime = startH + ptDuration + gap + 0.5;
         flowType = "PT ‚ûî ‡∏à‡∏µ‡∏ô";
      }
      if (needTTM) {
         ttmTime = formatTime(startH + ptDuration + gap);
         endTime = startH + ptDuration + gap + 1.0;
         flowType = "PT ‚ûî ‡πÑ‡∏ó‡∏¢";
      }
      if (!needTCM && !needTTM) {
         endTime = startH + ptDuration;
         flowType = "PT ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô";
      }
  }

  // Check Constraints
  if (ttmTime) {
     var ttmStart = timeToVal(ttmTime);
     if (ttmStart < 13 && (ttmStart + 1) > 12.001) return { error: true };
     if ((ttmStart + 1) > 16.001) return { error: true };
  }
  if (tcmTime) {
     var tcmStart = timeToVal(tcmTime);
     if (tcmStart < 13 && (tcmStart + 0.5) > 12.001) return { error: true };
     if ((tcmStart + 0.5) > 16.51) return { error: true };
  }
  if (startH < 13 && (startH + ptDuration) > 12.001) return { error: true };

  return { error: false, ttmTime: ttmTime, tcmTime: tcmTime, endTimeStr: formatTime(endTime), flowType: flowType };
}

function bookIMCQueue(data) {
   // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Placeholder - ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á Sheet ‡∏à‡∏£‡∏¥‡∏á)
   // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Row ‡πÅ‡∏•‡πâ‡∏ß setValue ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
   return { status: 'success', message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß IMC ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' };
}

// --- Helpers ---
function convertToSheetDate(fullDateStr) {
  // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤: "‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà 5 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2569"
  // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô: "5 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°" (‡∏ï‡∏≤‡∏°‡πÑ‡∏ü‡∏•‡πå CSV)
  try {
    var parts = fullDateStr.split(" "); 
    // parts[0]=‡∏ß‡∏±‡∏ô.., parts[1]=5, parts[2]=‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°, parts[3]=2569
    return parts[1] + " " + parts[2];
  } catch(e) { return fullDateStr; }
}

function cleanTime(t) {
  // ‡πÅ‡∏õ‡∏•‡∏á 08:30 -> 8:30 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
  if(!t) return "";
  if(t.startsWith("0")) return t.substring(1);
  return t;
}

function addHours(startH, add) { return formatTime(startH + add); }
function formatTime(val) {
  var h = Math.floor(val);
  var m = (val - h) * 60;
  if (Math.abs(m - 30) < 1) m = 30; else m = 0;
  var hStr = (h < 10) ? "0" + h : "" + h;
  var mStr = (m === 30) ? "30" : "00";
  return hStr + ":" + mStr;
}
function timeToVal(str) {
  if(!str) return 0;
  var p = str.split(":");
  return parseInt(p[0]) + (parseInt(p[1])/60);
}
